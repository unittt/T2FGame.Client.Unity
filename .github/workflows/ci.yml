name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'Runtime/**'
      - 'Editor/**'
      - 'Tests/**'
      - '*.asmdef'
      - 'package.json'
  pull_request:
    branches: [main]
    paths:
      - 'Runtime/**'
      - 'Editor/**'
      - 'Tests/**'
      - '*.asmdef'
      - 'package.json'
  workflow_dispatch:

env:
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

jobs:
  build:
    name: Build - Unity ${{ matrix.unity-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        unity-version:
          - 2022.3.0f1
        include:
          - unity-version: 2022.3.0f1
            unity-license-type: Professional

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ matrix.unity-version }}-${{ hashFiles('package.json') }}
          restore-keys: |
            Library-${{ matrix.unity-version }}-
            Library-

      # Create a minimal Unity project structure for package validation
      - name: Setup Unity Project
        run: |
          mkdir -p UnityProject/Assets
          mkdir -p UnityProject/Packages

          # Create manifest.json with package dependencies
          cat > UnityProject/Packages/manifest.json << 'EOF'
          {
            "dependencies": {
              "com.cysharp.unitask": "https://github.com/Cysharp/UniTask.git?path=src/UniTask/Assets/Plugins/UniTask",
              "com.psygames.unitywebsocket": "https://github.com/psygames/UnityWebSocket.git#upm",
              "com.unity.test-framework": "1.3.9"
            }
          }
          EOF

          # Link package to project
          ln -s ${{ github.workspace }} UnityProject/Packages/com.pisces.client

      - name: Run Unity Build
        uses: game-ci/unity-builder@v4
        with:
          projectPath: UnityProject
          targetPlatform: StandaloneLinux64
          buildMethod: ''
          versioning: None
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Build-Logs-${{ matrix.unity-version }}
          path: UnityProject/Logs/
          retention-days: 7

  # Validate package structure
  validate-package:
    name: Validate Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate package.json
        run: |
          echo "Validating package.json..."

          # Check required fields
          if ! jq -e '.name' package.json > /dev/null; then
            echo "Error: package.json missing 'name' field"
            exit 1
          fi

          if ! jq -e '.version' package.json > /dev/null; then
            echo "Error: package.json missing 'version' field"
            exit 1
          fi

          if ! jq -e '.unity' package.json > /dev/null; then
            echo "Error: package.json missing 'unity' field"
            exit 1
          fi

          # Validate version format (semver)
          VERSION=$(jq -r '.version' package.json)
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            exit 1
          fi

          echo "Package validation passed!"
          echo "  Name: $(jq -r '.name' package.json)"
          echo "  Version: $VERSION"
          echo "  Unity: $(jq -r '.unity' package.json)"

      - name: Validate Assembly Definitions
        run: |
          echo "Checking assembly definitions..."

          # Find all asmdef files
          ASMDEF_FILES=$(find . -name "*.asmdef" -type f)

          if [ -z "$ASMDEF_FILES" ]; then
            echo "Warning: No assembly definition files found"
            exit 0
          fi

          for file in $ASMDEF_FILES; do
            echo "Validating: $file"

            # Check if valid JSON
            if ! jq empty "$file" 2>/dev/null; then
              echo "Error: Invalid JSON in $file"
              exit 1
            fi

            # Check required fields
            if ! jq -e '.name' "$file" > /dev/null; then
              echo "Error: $file missing 'name' field"
              exit 1
            fi

            echo "  Name: $(jq -r '.name' "$file")"
          done

          echo "All assembly definitions are valid!"
