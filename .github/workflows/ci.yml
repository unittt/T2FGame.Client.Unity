name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'Runtime/**'
      - 'Editor/**'
      - 'Tests/**'
      - '*.asmdef'
      - 'package.json'
  pull_request:
    branches: [main]
    paths:
      - 'Runtime/**'
      - 'Editor/**'
      - 'Tests/**'
      - '*.asmdef'
      - 'package.json'
  workflow_dispatch:

jobs:
  validate-package:
    name: Validate Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate package.json
        run: |
          echo "Validating package.json..."

          # Check required fields
          if ! jq -e '.name' package.json > /dev/null; then
            echo "Error: package.json missing 'name' field"
            exit 1
          fi

          if ! jq -e '.version' package.json > /dev/null; then
            echo "Error: package.json missing 'version' field"
            exit 1
          fi

          if ! jq -e '.unity' package.json > /dev/null; then
            echo "Error: package.json missing 'unity' field"
            exit 1
          fi

          # Validate version format (semver)
          VERSION=$(jq -r '.version' package.json)
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            exit 1
          fi

          echo "Package validation passed!"
          echo "  Name: $(jq -r '.name' package.json)"
          echo "  Version: $VERSION"
          echo "  Unity: $(jq -r '.unity' package.json)"

      - name: Validate Assembly Definitions
        run: |
          echo "Checking assembly definitions..."

          # Find all asmdef files
          ASMDEF_FILES=$(find . -name "*.asmdef" -type f)

          if [ -z "$ASMDEF_FILES" ]; then
            echo "Warning: No assembly definition files found"
            exit 0
          fi

          for file in $ASMDEF_FILES; do
            echo "Validating: $file"

            # Check if valid JSON
            if ! jq empty "$file" 2>/dev/null; then
              echo "Error: Invalid JSON in $file"
              exit 1
            fi

            # Check required fields
            if ! jq -e '.name' "$file" > /dev/null; then
              echo "Error: $file missing 'name' field"
              exit 1
            fi

            echo "  Name: $(jq -r '.name' "$file")"
          done

          echo "All assembly definitions are valid!"
